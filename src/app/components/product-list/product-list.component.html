<!-- Ana Sayfa Konteyneri -->
<div class="space-y-6">

  <!-- Sayfa Başlığı ve Buton Alanı -->
  <header class="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
    <div>
      <h1 class="text-2xl font-bold tracking-tight text-foreground md:text-3xl">Ürün Yönetimi</h1>
      <p class="mt-1 text-muted-foreground">Mevcut ürünleri görüntüleyin, düzenleyin, yeni ürün ekleyin veya görsel geliştirip iliştirin.</p>
    </div>
    <button (click)="openAddPanel()"
      class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow-sm transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50">
      <i class="bi bi-plus-circle-fill"></i>
      <span>Yeni Ürün Ekle</span>
    </button>
  </header>

  <!-- Ürün Listesi Tablosu -->
  <div class="overflow-hidden rounded-lg border border-border bg-card shadow-sm">
    <div class="overflow-x-auto">
      <table class="w-full">
        <!-- Tablo Başlığı -->
        <thead class="bg-muted/50">
          <tr>
            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Görsel</th>
            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Ürün Adı</th>
            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Kategori</th>
            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Fiyat</th>
            <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground">Stok</th>
            <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground">İşlemler</th>
          </tr>
        </thead>
        <!-- Tablo İçeriği -->
        <tbody class="divide-y divide-border">
          <tr *ngIf="loading">
            <td colspan="6" class="p-8 text-center text-muted-foreground">
              <i class="bi bi-arrow-clockwise animate-spin mr-2"></i> Yükleniyor...
            </td>
          </tr>
          <tr *ngIf="!loading && products.length === 0">
            <td colspan="6" class="p-8 text-center text-muted-foreground">Henüz hiç ürün eklenmemiş.</td>
          </tr>
          <tr *ngFor="let product of products" class="hover:bg-muted/50">
            <td class="p-2 align-middle">
              <div class="w-10 h-10 overflow-hidden rounded">
                <img *ngIf="product.imageUrl; else placeholder"
                     [src]="environment.url + product.imageUrl"
                     alt="{{ product.name }}"
                     class="object-cover w-full h-full" />
                <ng-template #placeholder>
                  <div class="flex items-center justify-center bg-muted text-xs text-muted-foreground w-full h-full">
                    Yok
                  </div>
                </ng-template>
              </div>
            </td>
            <td class="p-4 align-middle font-medium text-foreground">{{ product.name }}</td>
            <td class="p-4 align-middle text-muted-foreground">{{ product.categoryName }}</td>
            <td class="p-4 align-middle text-muted-foreground">{{ product.price | currency:'TRY':'symbol':'1.2-2' }}</td>
            <td class="p-4 text-center align-middle text-muted-foreground">{{ product.stock }}</td>
            <td class="p-4 text-right align-middle">
              <div class="inline-flex items-center gap-2">
                <button (click)="openAnalysisModal(product)" title="Fiyat Analizi Yap"
                  class="flex h-8 w-8 items-center justify-center rounded-md border border-sky-500/50 text-sky-500 transition-colors hover:bg-sky-500 hover:text-white">
                  <i class="bi bi-search"></i>
                </button>
                <button (click)="openEditPanel(product)" title="Düzenle"
                  class="flex h-8 w-8 items-center justify-center rounded-md border border-border transition-colors hover:bg-muted">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button (click)="confirmDelete(product.productId)" title="Sil"
                  class="flex h-8 w-8 items-center justify-center rounded-md border border-destructive/50 text-destructive transition-colors hover:bg-destructive hover:text-destructive-foreground">
                  <i class="bi bi-trash3-fill"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Yandan Açılır Panel (Sheet) - Ekleme ve Düzenleme için Ortak -->
<div *ngIf="isPanelOpen" class="fixed inset-0 z-50">
  <div (click)="closePanel()" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

  <aside class="absolute inset-y-0 right-0 flex w-full max-w-lg flex-col border-l border-border bg-card">

    <!-- Başlık -->
    <header class="flex h-16 shrink-0 items-center justify-between border-b border-border px-6">
      <h2 class="text-lg font-semibold">
        {{ panelMode === 'add' ? 'Yeni Ürün Ekle' : 'Ürünü Düzenle' }}
      </h2>
      <button (click)="closePanel()"
        class="flex h-8 w-8 items-center justify-center rounded-full transition-colors hover:bg-muted">
        <i class="bi bi-x-lg"></i>
        <span class="sr-only">Paneli Kapat</span>
      </button>
    </header>

    <!-- İçerik -->
    <main class="flex-1 overflow-y-auto p-6 space-y-6">
      <!-- EKLEME FORMU -->
      <form *ngIf="panelMode === 'add'" #addForm="ngForm" (ngSubmit)="saveNewProductWithImage(addForm)" class="space-y-4">
        <div>
          <label for="add-name" class="mb-1.5 block text-sm font-medium">Ürün Adı</label>
          <input id="add-name" type="text" name="name" [(ngModel)]="newProduct.name" required
            class="w-full rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring">
        </div>

        <div>
          <label for="add-category" class="mb-1.5 block text-sm font-medium">Kategori</label>
          <select id="add-category" name="categoryId" [(ngModel)]="newProduct.categoryId" required
            class="w-full rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring">
            <option [ngValue]="null" disabled>Kategori seçin...</option>
            <option *ngFor="let cat of categories" [value]="cat.categoryId">{{ cat.name }}</option>
          </select>
        </div>

        <div>
          <label for="add-description" class="mb-1.5 block text-sm font-medium">Açıklama (İsteğe Bağlı)</label>
          <textarea id="add-description" name="description" [(ngModel)]="newProduct.description" rows="4"
            class="w-full resize-none rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="add-price" class="mb-1.5 block text-sm font-medium">Fiyat</label>
            <input id="add-price" type="number" name="price" [(ngModel)]="newProduct.price" required min="0"
              class="w-full rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring">
          </div>
          <div>
            <label for="add-stock" class="mb-1.5 block text-sm font-medium">Stok Adedi</label>
            <input id="add-stock" type="number" name="stock" [(ngModel)]="newProduct.stock" required min="0"
              class="w-full rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring">
          </div>
        </div>

        <!-- Görsel Yükleme ve Geliştirme (İyileştirilmiş) -->
        <div class="space-y-4 border border-border rounded-md p-4 bg-muted/5">
          <div class="flex flex-col sm:flex-row gap-6">
            <!-- Sol: Talimat + Yükleme + Aksiyon -->
            <div class="flex-1 space-y-3">
              <div class="flex items-center justify-between">
                <span class="text-sm font-semibold">Ürün Görseli & Geliştirme</span>
                <span *ngIf="isEnhancing" class="inline-flex items-center gap-1 text-xs text-primary">
                  <i class="bi bi-arrow-clockwise animate-spin"></i> Geliştiriliyor...
                </span>
              </div>

              <!-- Talimat -->
              <div>
                <label for="enhance-instruction" class="block text-xs font-medium mb-1">Görsel Talimatı</label>
                <textarea id="enhance-instruction" name="enhanceInstruction" [(ngModel)]="enhanceInstruction"
                  rows="3"
                  placeholder="Örn: Arka planı beyaz yap, gölgeleri yumuşat, ürün net olsun"
                  class="w-full resize-none rounded-md border border-input bg-background p-3 text-sm focus:outline-none focus:ring-2 focus:ring-ring"></textarea>
              </div>

              <!-- Görsel Yükleme -->
              <div>
                <label class="block text-xs font-medium mb-1">Orijinal Görsel Yükle</label>
                <div class="flex items-center gap-3">
                  <label
                    class="inline-flex cursor-pointer items-center gap-2 rounded-md border border-border bg-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-primary/5 transition">
                    <i class="bi bi-upload"></i>
                    <span>Görsel Seç</span>
                    <input type="file" (change)="onFileSelected($event)" accept="image/*" class="sr-only" />
                  </label>
                  <div *ngIf="uploadedFile" class="text-sm text-foreground truncate">
                    {{ uploadedFile.name }}
                  </div>
                </div>
              </div>

              <!-- Butonlar -->
              <div class="flex flex-wrap gap-2 mt-1">
                <button type="button"
                  (click)="enhanceImageForNewProduct()"
                  [disabled]="!uploadedFile || isEnhancing"
                  class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow hover:bg-primary/90 transition">
                  <i class="bi bi-brush"></i>
                  <span>{{ isEnhancing ? 'Geliştiriliyor...' : 'Geliştir & Önizle' }}</span>
                </button>

                <button *ngIf="tempImageUrl"
                  type="button"
                  (click)="saveNewProductWithImage(addForm)"
                  [disabled]="addForm.invalid || isEnhancing"
                  class="inline-flex items-center gap-2 rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white shadow hover:bg-green-700 transition">
                  <i class="bi bi-check-circle"></i>
                  <span>Onayla & Kaydet</span>
                </button>

                <button *ngIf="tempImageUrl"
                  type="button"
                  (click)="tempImageUrl = null"
                  class="inline-flex items-center gap-1 rounded-md border border-border bg-transparent px-3 py-2 text-xs font-medium hover:bg-accent transition">
                  <i class="bi bi-x-lg"></i>
                  <span>Önizlemeyi Kaldır</span>
                </button>
              </div>
            </div>

            <!-- Sağ: Önizlemeler -->
            <div class="flex-1 grid grid-cols-1 gap-4">
              <!-- Orijinal Görsel Önizlemesi -->
              <div class="space-y-1">
                <p class="text-xs font-medium">Yüklenen Orijinal Görsel</p>
                <div class="relative w-full h-40 rounded-md border border-border bg-white flex items-center justify-center overflow-hidden">
                  <ng-container *ngIf="uploadedFile; else noOriginal">
                    <img [src]="uploadedFile | filePreview" alt="Orijinal Görsel" class="object-contain w-full h-full" />
                  </ng-container>
                  <ng-template #noOriginal>
                    <div class="text-center text-muted-foreground text-xs">Henüz görsel yüklenmedi.</div>
                  </ng-template>
                </div>
              </div>

              <!-- Geliştirilmiş Görsel Önizlemesi -->
              <div class="space-y-1">
                <p class="text-xs font-medium flex justify-between">
                  <span>Geliştirilmiş Görsel</span>
                  <span *ngIf="!tempImageUrl" class="text-[10px] text-muted-foreground">Önizleme yok</span>
                </p>
                <div class="relative w-full h-40 rounded-md border border-border bg-white flex items-center justify-center overflow-hidden">
                  <ng-container *ngIf="tempImageUrl; else noEnhanced">
                    <img [src]="environment.url + tempImageUrl" alt="Geliştirilmiş Görsel" class="object-contain w-full h-full" />
                    <div class="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-2 py-1 rounded">
                      Önizleme
                    </div>
                  </ng-container>
                  <ng-template #noEnhanced>
                    <div class="text-center text-muted-foreground text-xs">Geliştirilmiş görsel yok.</div>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Aksiyon Butonları -->
        <div class="flex justify-end gap-2">
          <button type="button" (click)="closePanel()"
            class="rounded-md border border-border bg-transparent px-4 py-2 text-sm font-medium hover:bg-accent">
            İptal
          </button>
          <button type="button" (click)="openAnalysisModalForNewProduct()"
            [disabled]="!newProduct.name || newProduct.name.trim() === ''"
            class="rounded-md border border-sky-500 px-4 py-2 text-sm font-medium hover:bg-sky-500/10">
            Fiyat Analizi
          </button>
          <button type="submit"
            [disabled]="addForm.invalid || isEnhancing"
            class="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 disabled:opacity-50">
            Ürünü Kaydet
          </button>
        </div>
      </form>

      <!-- DÜZENLEME FORMU -->
      <form *ngIf="panelMode === 'edit' && selectedProduct" #editForm="ngForm" (ngSubmit)="updateProduct(editForm)"
        class="space-y-4">
        <div>
          <label for="edit-name" class="mb-1.5 block text-sm font-medium">Ürün Adı</label>
          <input id="edit-name" type="text" name="name" [(ngModel)]="selectedProduct.name" required
            class="w-full rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring">
        </div>

        <div>
          <label for="edit-category" class="mb-1.5 block text-sm font-medium">Kategori</label>
          <select id="edit-category" name="categoryId" [(ngModel)]="selectedProduct.categoryId" required
            class="w-full rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring">
            <option *ngFor="let cat of categories" [value]="cat.categoryId">{{ cat.name }}</option>
          </select>
        </div>

        <div>
          <label for="edit-description" class="mb-1.5 block text-sm font-medium">Açıklama (İsteğe Bağlı)</label>
          <textarea id="edit-description" name="description" [(ngModel)]="selectedProduct.description" rows="4"
            class="w-full resize-none rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="edit-price" class="mb-1.5 block text-sm font-medium">Fiyat</label>
            <input id="edit-price" type="number" name="price" [(ngModel)]="selectedProduct.price" required min="0"
              class="w-full rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring">
          </div>
          <div>
            <label for="edit-stock" class="mb-1.5 block text-sm font-medium">Stok Adedi</label>
            <input id="edit-stock" type="number" name="stock" [(ngModel)]="selectedProduct.stock" required min="0"
              class="w-full rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring">
          </div>
        </div>

        <!-- Aksiyon Butonları -->
        <div class="flex justify-end gap-2">
          <button type="button" (click)="closePanel()"
            class="rounded-md border border-border bg-transparent px-4 py-2 text-sm font-medium hover:bg-accent">
            İptal
          </button>
          <button type="submit" [disabled]="editForm.invalid"
            class="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 disabled:opacity-50">
            Değişiklikleri Kaydet
          </button>
        </div>
      </form>
    </main>

    <!-- Footer: sadece boşluk veya ekstra bilgi istersen bırak, submit butonlar formlarda -->
    <footer class="flex shrink-0 justify-end border-t border-border px-6 py-3">
      <!-- İstersen burada ilave kısa not/yardım koyabilirsin -->
    </footer>
  </aside>
</div>

<!-- Fiyat Analiz Modalı -->
<div *ngIf="isAnalysisModalOpen" class="fixed inset-0 z-50 flex items-center justify-center">
  <!-- Arka Plan Karartma -->
  <div (click)="closeAnalysisModal()" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>

  <!-- Modal Konteyneri -->
  <div class="relative m-4 w-full max-w-2xl rounded-lg bg-card shadow-xl border border-border">
    <!-- Modal Başlığı -->
    <header class="flex items-center justify-between border-b border-border p-4">
      <h2 class="text-lg font-semibold">
        <i class="bi bi-bar-chart-line-fill mr-2 text-primary"></i>
        Fiyat Analizi: <span class="font-bold text-primary">{{ analysisProductName }}</span>
      </h2>
      <button (click)="closeAnalysisModal()"
        class="flex h-8 w-8 items-center justify-center rounded-full transition-colors hover:bg-muted">
        <i class="bi bi-x-lg"></i>
      </button>
    </header>

    <!-- Modal İçeriği -->
    <main class="p-6">
      <!-- Yükleniyor Durumu -->
      <div *ngIf="isAnalysisLoading" class="flex flex-col items-center justify-center space-y-3 py-10">
        <i class="bi bi-arrow-clockwise h-10 w-10 animate-spin text-primary"></i>
        <p class="text-muted-foreground">Analiz sonuçları internetten alınıyor, lütfen bekleyin...</p>
      </div>

      <!-- Sonuçlar Gösterim Alanı -->
      <div *ngIf="!isAnalysisLoading && analysisResult" class="space-y-6">
        <!-- Fiyat Kartları -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
          <div class="rounded-md border border-green-500/30 bg-green-500/10 p-4 text-center">
            <p class="text-sm font-medium text-green-400">En Düşük Fiyat</p>
            <p class="text-2xl font-bold text-foreground">{{ analysisResult.minPrice || 'N/A' }}</p>
          </div>
          <div class="rounded-md border border-red-500/30 bg-red-500/10 p-4 text-center">
            <p class="text-sm font-medium text-red-400">En Yüksek Fiyat</p>
            <p class="text-2xl font-bold text-foreground">{{ analysisResult.maxPrice || 'N/A' }}</p>
          </div>
          <div class="rounded-md border border-blue-500/30 bg-blue-500/10 p-4 text-center">
            <p class="text-sm font-medium text-blue-400">Ortalama Fiyat</p>
            <p class="text-2xl font-bold text-foreground">{{ analysisResult.averagePrice || 'N/A' }}</p>
          </div>
        </div>

        <!-- Satıcı Linkleri Tablosu -->
        <div>
          <h3 class="mb-2 font-semibold">Bulunan Satıcılar</h3>
          <div class="max-h-60 overflow-y-auto rounded-md border border-border">
            <table class="w-full">
              <tbody class="divide-y divide-border">
                <tr *ngIf="analysisResult.retailers.length === 0">
                  <td class="p-4 text-center text-muted-foreground">Online satıcı bulunamadı.</td>
                </tr>
                <tr *ngFor="let retailer of analysisResult.retailers" class="hover:bg-muted/50">
                  <td class="p-3 font-medium">{{ retailer.storeName }}</td>
                  <td class="p-3 text-right">
                    <a [href]="retailer.url" target="_blank" rel="noopener noreferrer"
                      class="inline-flex items-center gap-2 rounded-md bg-primary px-3 py-1.5 text-sm text-primary-foreground hover:bg-primary/90">
                      <span>Mağazaya Git</span>
                      <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
