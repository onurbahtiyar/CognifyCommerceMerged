<!-- ANA KONTEYNER: Tüm yüksekliği kullanır ve dikey flex düzeni sağlar. -->
<div class="flex h-full flex-col bg-background">

  <!-- MESAJ LİSTESİ ALANI: Mevcut tüm boşluğu doldurur ve kaydırma çubuğu içerir. -->
  <main #scrollContainer class="flex-1 overflow-y-auto">
    <div class="mx-auto max-w-4xl space-y-8 px-4 py-8 sm:px-6 lg:px-8">

      <!-- Mesaj Döngüsü -->
      <div *ngFor="let msg of messages">
        <!-- Bot Mesajı (Sola Hizalı) -->
        <div *ngIf="msg.sender === 'bot'" class="flex items-start gap-4">
          <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-card text-primary shadow-sm ring-1 ring-border">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
          </div>
          <div class="max-w-2xl rounded-b-xl rounded-tr-xl bg-card p-4 ring-1 ring-border">
             <div class="prose prose-sm max-w-none prose-p:text-foreground prose-headings:text-foreground dark:prose-invert">
                <div [innerHTML]="msg.cachedHtml | async"></div>
                <div *ngIf="msg.data" class="not-prose mt-4 overflow-hidden rounded-lg border border-border">
                  <table class="min-w-full divide-y divide-border">
                    <thead class="bg-muted/50">
                      <tr><th *ngFor="let head of msg.data.headers" class="px-4 py-2.5 text-left text-xs font-semibold uppercase tracking-wider text-muted-foreground">{{ head | titlecase }}</th></tr>
                    </thead>
                    <tbody class="divide-y divide-border bg-background">
                      <tr *ngFor="let row of msg.data.rows"><td *ngFor="let head of msg.data.headers" class="whitespace-nowrap px-4 py-3 text-sm">{{ row[head] }}</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
          </div>
        </div>
        
        <!-- Kullanıcı Mesajı (Sağa Hizalı) -->
        <div *ngIf="msg.sender === 'user'" class="flex items-start justify-end gap-4">
          <div class="max-w-2xl rounded-b-xl rounded-tl-xl bg-primary p-4 text-primary-foreground shadow-md">
            <p class="whitespace-pre-wrap text-base font-normal">{{ msg.text }}</p>
          </div>
           <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-muted-foreground/20 text-sm font-bold text-muted-foreground">
            {{ (msg.text ? msg.text.slice(0, 1) : '') | uppercase }}
          </div>
        </div>
      </div>

      <!-- Yazıyor... Animasyonu -->
      <div *ngIf="loading" class="flex items-start gap-4">
        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-card text-primary shadow-sm ring-1 ring-border">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
        </div>
        <div class="flex h-12 items-center rounded-b-xl rounded-tr-xl bg-card p-4 ring-1 ring-border">
          <div class="flex items-center space-x-1.5">
            <div class="h-2 w-2 animate-pulse rounded-full bg-muted-foreground"></div>
            <div class="h-2 w-2 animate-pulse rounded-full bg-muted-foreground [animation-delay:0.15s]"></div>
            <div class="h-2 w-2 animate-pulse rounded-full bg-muted-foreground [animation-delay:0.3s]"></div>
          </div>
        </div>
      </div>
      
    </div>
  </main>

  <!-- GİRİŞ ALANI -->
  <footer class="shrink-0 border-t border-border bg-card/80 p-4 backdrop-blur-sm sm:p-6">
    <div class="mx-auto max-w-4xl">

      <!-- Etiketleme Menüsü (@mention) -->
      <div *ngIf="mentionPopup.isOpen" class="mb-2 rounded-lg border bg-card shadow-xl">
        <div class="border-b p-2">
          <input type="text"
                 placeholder="{{mentionPopup.type | titlecase}} ara..."
                 [(ngModel)]="mentionPopup.searchTerm"
                 (ngModelChange)="filterMentionSuggestions()"
                 class="w-full rounded-md border-input bg-background p-2 focus:ring-2 focus:ring-ring">
        </div>
        <ul class="max-h-64 overflow-y-auto">
          <!-- Müşteri Önerileri -->
          <ng-container *ngIf="mentionPopup.type === 'kullanıcı'">
            <li *ngFor="let item of mentionPopup.suggestions" (click)="selectMention(item, 'customer')"
                class="flex cursor-pointer items-center gap-3 px-4 py-2 hover:bg-muted">
              <div class="font-medium">{{item.firstName}} {{item.lastName}}</div>
              <div class="text-sm text-muted-foreground">{{item.email}}</div>
            </li>
          </ng-container>
          <!-- Ürün Önerileri -->
          <ng-container *ngIf="mentionPopup.type === 'ürün'">
            <li *ngFor="let item of mentionPopup.suggestions" (click)="selectMention(item, 'product')"
                class="flex cursor-pointer items-center justify-between px-4 py-2 hover:bg-muted">
              <div class="font-medium">{{item.name}}</div>
              <div class="text-sm text-muted-foreground">Stok: {{item.stock}}</div>
            </li>
          </ng-container>
          <!-- Sipariş Önerileri -->
          <ng-container *ngIf="mentionPopup.type === 'sipariş'">
             <li *ngFor="let item of mentionPopup.suggestions" (click)="selectMention(item, 'order')"
                class="flex cursor-pointer items-center justify-between px-4 py-2 hover:bg-muted">
              <div class="font-medium">#{{item.orderId}} - {{item.customerFullName}}</div>
              <div class="text-sm text-muted-foreground">{{item.orderDate | date:'short'}}</div>
            </li>
          </ng-container>
           <li *ngIf="mentionPopup.suggestions.length === 0" class="px-4 py-2 text-center text-muted-foreground">
            Sonuç bulunamadı.
          </li>
        </ul>
      </div>

      <!-- Giriş Alanı (contenteditable div) -->
      <div class="relative">
        <div #promptInput
             contenteditable="true"
             (keydown)="handleKeyDown($event)"
             (input)="handleInput($event)"
             [attr.data-placeholder]="isInputEmpty ? 'AI ile sohbet edin veya bir soru sorun... (@kullanıcı, @ürün, @sipariş)' : ''"
             class="prompt-input w-full min-h-[56px] resize-none overflow-y-auto rounded-xl border-border bg-muted p-4 pr-16 text-base text-foreground shadow-inner transition-colors focus:border-primary/50 focus:bg-background focus:ring-2 focus:ring-primary/50"
        ></div>
        <button (click)="send()" [disabled]="loading || isInputEmpty"
                class="absolute bottom-3 right-3 flex h-10 w-10 items-center justify-center rounded-lg bg-primary text-primary-foreground transition-all duration-200 ease-in-out hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background disabled:cursor-not-allowed disabled:bg-muted disabled:text-muted-foreground">
          <i class="bi bi-arrow-up text-xl"></i>
        </button>
      </div>
      
    </div>
  </footer>
</div>